name: Build Wheels

on:
  workflow_dispatch:
  pull_request:

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.sha }}
  cancel-in-progress: true

jobs:
  # ──────────────────────────────────────────────────────────────────────────
  # Stage 1: Prebuild (one job per OS/arch)
  #   - Builds filepattern + pybind11 → prereq_cache/
  #   - Builds TensorStore deps via FetchContent → ts_fc_cache/
  #   - Both caches are restored by wheel-build jobs below.
  # ──────────────────────────────────────────────────────────────────────────
  prebuild:
    name: Prebuild on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-22.04
            cibw_archs: auto64
          - os: macos-15-intel
            cibw_archs: auto64
          - os: windows-latest
            cibw_archs: auto64
          - os: macos-14
            cibw_archs: arm64

    steps:
      - uses: actions/checkout@v3
        name: Check out

      - name: Restore prereq cache
        id: prereq-cache
        uses: actions/cache@v4
        with:
          path: prereq_cache
          key: prereq-${{ matrix.os }}-${{ matrix.cibw_archs }}-${{ hashFiles('ci-utils/install_prereq_linux.sh', 'ci-utils/install_prereq_win.bat') }}

      - name: Restore TensorStore FetchContent cache
        id: ts-cache
        uses: actions/cache@v4
        with:
          path: ts_fc_cache
          key: ts-fc-${{ matrix.os }}-${{ matrix.cibw_archs }}-${{ hashFiles('CMakeLists.txt', 'ci-utils/tensorstore_prebuild/CMakeLists.txt') }}

      # ── Linux: run prebuild inside the same manylinux container cibuildwheel uses ──
      - name: Run Linux prebuild in manylinux container
        if: (steps.prereq-cache.outputs.cache-hit != 'true' || steps.ts-cache.outputs.cache-hit != 'true') && matrix.os == 'ubuntu-22.04'
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/project \
            -w /project \
            quay.io/pypa/manylinux_2_28_x86_64 \
            bash ci-utils/prebuild_linux.sh

      # ── macOS: brew + install prereqs + cmake TensorStore prebuild ──
      - name: Run macOS prebuild
        if: (steps.prereq-cache.outputs.cache-hit != 'true' || steps.ts-cache.outputs.cache-hit != 'true') && startsWith(matrix.os, 'macos')
        run: |
          brew install nasm
          if [[ "${{ matrix.os }}" == "macos-14" ]]; then
            brew uninstall --ignore-dependencies jpeg-turbo || true
          else
            brew uninstall --ignore-dependencies openssl || true
            sudo rm -rf /usr/local/include/openssl
          fi
          # Build filepattern + pybind11 (and sys deps zlib/jpeg/png) → prereq_cache/local_install
          bash ci-utils/install_prereq_linux.sh ./prereq_cache/local_install
          # Build TensorStore using the minimal prebuild cmake project (no Python/pybind11 needed)
          CMAKE_FLAGS="-DTENSORSTORE_USE_SYSTEM_JPEG=ON -DFETCHCONTENT_BASE_DIR=${{ github.workspace }}/ts_fc_cache"
          if [[ "${{ matrix.os }}" == "macos-15-intel" ]]; then
            CMAKE_FLAGS="${CMAKE_FLAGS} -DCMAKE_CXX_FLAGS=-Wno-missing-template-arg-list-after-template-kw -DTENSORSTORE_USE_SYSTEM_ZLIB=ON -DTENSORSTORE_USE_SYSTEM_PNG=ON"
          fi
          cmake -S ci-utils/tensorstore_prebuild -B /tmp/ts_cmake_prebuild \
            -DCMAKE_BUILD_TYPE=Release ${CMAKE_FLAGS}
          cmake --build /tmp/ts_cmake_prebuild -j$(sysctl -n hw.ncpu)

      # ── Windows: MSVC env + NASM + Ninja + install prereqs + cmake TensorStore prebuild ──
      - name: Set up MSVC environment (Windows)
        if: matrix.os == 'windows-latest'
        uses: ilammy/msvc-dev-cmd@v1

      - name: Add NASM (Windows)
        if: (steps.prereq-cache.outputs.cache-hit != 'true' || steps.ts-cache.outputs.cache-hit != 'true') && matrix.os == 'windows-latest'
        uses: ilammy/setup-nasm@v1

      - name: Add Ninja (Windows)
        if: (steps.prereq-cache.outputs.cache-hit != 'true' || steps.ts-cache.outputs.cache-hit != 'true') && matrix.os == 'windows-latest'
        uses: seanmiddleditch/gha-setup-ninja@master

      - name: Run Windows prebuild
        if: (steps.prereq-cache.outputs.cache-hit != 'true' || steps.ts-cache.outputs.cache-hit != 'true') && matrix.os == 'windows-latest'
        shell: cmd
        run: |
          ci-utils\install_prereq_win.bat
          if %errorlevel% neq 0 exit /b %errorlevel%
          xcopy /E /I /y local_install prereq_cache\local_install
          cmake -S ci-utils\tensorstore_prebuild -B C:\ts_cmake_prebuild -DCMAKE_GENERATOR=Ninja -DFETCHCONTENT_BASE_DIR=${{ github.workspace }}/ts_fc_cache -DCMAKE_BUILD_TYPE=Release
          if %errorlevel% neq 0 exit /b %errorlevel%
          cmake --build C:\ts_cmake_prebuild
          if %errorlevel% neq 0 exit /b %errorlevel%

  # ──────────────────────────────────────────────────────────────────────────
  # Stage 2: Build wheels (4 parallel jobs per Python version, per OS)
  #   Each job restores both caches from the prebuild stage above.
  # ──────────────────────────────────────────────────────────────────────────
  build_wheels:
    name: Build wheels on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    needs: [prebuild]
    continue-on-error: true

    env:
      MACOSX_DEPLOYMENT_TARGET: "10.15"
    strategy:
      matrix:
        os: [ubuntu-22.04, macos-15-intel, windows-latest]
        cibw_archs: ["auto64"]
        cibw_build: ["cp310", "cp311", "cp312", "cp313"]

    steps:
      - uses: actions/checkout@v3
        name: Check out

      - name: Restore prereq cache
        uses: actions/cache@v4
        with:
          path: prereq_cache
          key: prereq-${{ matrix.os }}-${{ matrix.cibw_archs }}-${{ hashFiles('ci-utils/install_prereq_linux.sh', 'ci-utils/install_prereq_win.bat') }}

      - name: Restore TensorStore FetchContent cache
        uses: actions/cache@v4
        with:
          path: ts_fc_cache
          key: ts-fc-${{ matrix.os }}-${{ matrix.cibw_archs }}-${{ hashFiles('CMakeLists.txt', 'ci-utils/tensorstore_prebuild/CMakeLists.txt') }}

      - uses: ilammy/msvc-dev-cmd@v1
        name: Add MSVS Path

      - name: Add NASM
        if: matrix.os == 'windows-latest'
        uses: ilammy/setup-nasm@v1

      - name: Add Ninja
        if: matrix.os == 'windows-latest'
        uses: seanmiddleditch/gha-setup-ninja@master

      - uses: actions/setup-python@v4
        name: Install Python
        with:
          python-version: '3.11'

      - name: Install cibuildwheel
        run: |
          python -m pip install cibuildwheel delvewheel wheel

      - name: Building wheels
        run: |
          python -m cibuildwheel --output-dir dist
        env:
          CIBW_BUILD: ${{ matrix.cibw_build }}-*
          CIBW_BUILD_VERBOSITY: 3
          CIBW_SKIP: "*musllinux*"
          CIBW_MANYLINUX_X86_64_IMAGE: manylinux_2_28
          CIBW_BEFORE_ALL_MACOS: brew install nasm &&
                          brew uninstall --ignore-dependencies openssl || true &&
                          sudo rm -rf /usr/local/include/openssl &&
                          bash ci-utils/before_all_macos.sh
          CIBW_BEFORE_ALL_LINUX: bash /project/ci-utils/before_all_linux.sh
          CIBW_BEFORE_ALL_WINDOWS: ci-utils\before_all_win.bat
          CIBW_ENVIRONMENT_MACOS: >-
            MACOSX_DEPLOYMENT_TARGET=11.0
            REPAIR_LIBRARY_PATH="/tmp/argolid_bld/local_install/lib:/tmp/argolid_bld/local_install/lib64"
            ON_GITHUB="TRUE"
            ARGOLID_DEP_DIR="/tmp/argolid_bld/local_install"
            CMAKE_ARGS="-DCMAKE_CXX_FLAGS=-Wno-missing-template-arg-list-after-template-kw -DTENSORSTORE_USE_SYSTEM_JPEG=ON -DTENSORSTORE_USE_SYSTEM_ZLIB=ON -DTENSORSTORE_USE_SYSTEM_PNG=ON -DFETCHCONTENT_BASE_DIR=${{ github.workspace }}/ts_fc_cache"
          CIBW_ENVIRONMENT_LINUX: >-
            LD_LIBRARY_PATH="/tmp/argolid_bld/local_install/lib:/tmp/argolid_bld/local_install/lib64:$LD_LIBRARY_PATH"
            ON_GITHUB="TRUE"
            ARGOLID_DEP_DIR="/tmp/argolid_bld/local_install"
            CMAKE_ARGS="-DTENSORSTORE_USE_SYSTEM_JPEG=ON -DTENSORSTORE_USE_SYSTEM_ZLIB=ON -DTENSORSTORE_USE_SYSTEM_PNG=ON -DFETCHCONTENT_BASE_DIR=/project/ts_fc_cache"
          CIBW_REPAIR_WHEEL_COMMAND_MACOS: DYLD_LIBRARY_PATH=$REPAIR_LIBRARY_PATH delocate-listdeps {wheel} && DYLD_LIBRARY_PATH=$REPAIR_LIBRARY_PATH delocate-wheel --require-archs {delocate_archs} -w {dest_dir} {wheel}
          CIBW_ENVIRONMENT_WINDOWS: PATH="$TEMP\\argolid\\bin;$PATH" ON_GITHUB="TRUE" ARGOLID_DEP_DIR="C:\\TEMP\\argolid_bld\\local_install" CMAKE_ARGS="-DCMAKE_GENERATOR=Ninja -DFETCHCONTENT_BASE_DIR=${{ github.workspace }}/ts_fc_cache"
          CIBW_REPAIR_WHEEL_COMMAND_WINDOWS: "delvewheel repair -w {dest_dir} {wheel}"
          CIBW_ARCHS: ${{ matrix.cibw_archs }}
          CIBW_BEFORE_TEST_LINUX: dnf -y install maven java
          CIBW_TEST_REQUIRES: bfio>=2.4.0 tensorstore numpy pytest
          CIBW_TEST_COMMAND: python -W default -m pytest -vv -s {project}/tests/python

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: argolid-wheels-${{ matrix.os }}-${{ matrix.cibw_archs }}-${{ matrix.cibw_build }}
          path: dist/*.whl
          retention-days: 1

  build_wheels_apple_arm64:
    name: Build wheels on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    needs: [prebuild]
    continue-on-error: true
    env:
      MACOSX_DEPLOYMENT_TARGET: "11.0"
    strategy:
      matrix:
        os: [macos-14]
        cibw_archs: ["arm64"]
        cibw_build: ["cp310", "cp311", "cp312", "cp313"]

    steps:
      - uses: actions/checkout@v3
        name: Check out

      - name: Restore prereq cache
        uses: actions/cache@v4
        with:
          path: prereq_cache
          key: prereq-${{ matrix.os }}-${{ matrix.cibw_archs }}-${{ hashFiles('ci-utils/install_prereq_linux.sh', 'ci-utils/install_prereq_win.bat') }}

      - name: Restore TensorStore FetchContent cache
        uses: actions/cache@v4
        with:
          path: ts_fc_cache
          key: ts-fc-${{ matrix.os }}-${{ matrix.cibw_archs }}-${{ hashFiles('CMakeLists.txt', 'ci-utils/tensorstore_prebuild/CMakeLists.txt') }}

      - uses: actions/setup-python@v4
        name: Install Python
        with:
          python-version: '3.11'

      - name: Install cibuildwheel
        run: |
          python -m pip install cibuildwheel delocate wheel

      - name: Building wheels
        run: |
          python -m cibuildwheel --output-dir dist
        env:
          CIBW_BUILD: ${{ matrix.cibw_build }}-*
          CIBW_BUILD_VERBOSITY: 3
          CIBW_ARCHS_MACOS: arm64
          CIBW_BEFORE_ALL_MACOS: brew install nasm &&
                                  brew uninstall --ignore-dependencies jpeg-turbo &&
                                  bash ci-utils/before_all_macos.sh
          CIBW_ENVIRONMENT_MACOS: >-
            MACOSX_DEPLOYMENT_TARGET=11.0
            REPAIR_LIBRARY_PATH="/tmp/argolid_bld/local_install/lib:/tmp/argolid_bld/local_install/lib64"
            ON_GITHUB="TRUE"
            ARGOLID_DEP_DIR="/tmp/argolid_bld/local_install"
            CMAKE_ARGS="-DTENSORSTORE_USE_SYSTEM_JPEG=ON -DFETCHCONTENT_BASE_DIR=${{ github.workspace }}/ts_fc_cache"
          CIBW_REPAIR_WHEEL_COMMAND_MACOS: |
            DYLD_LIBRARY_PATH=$REPAIR_LIBRARY_PATH delocate-listdeps {wheel} &&
            MACOSX_DEPLOYMENT_TARGET=11.0 DYLD_LIBRARY_PATH=$REPAIR_LIBRARY_PATH delocate-wheel --require-archs {delocate_archs} -w {dest_dir} {wheel} -e libc++ -e libunwind
          CIBW_ARCHS: ${{ matrix.cibw_archs }}
          CIBW_TEST_REQUIRES: bfio>=2.4.0 tensorstore numpy pytest
          CIBW_TEST_COMMAND: python -W default -m pytest -vv -s {project}/tests/python

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: argolid-wheels-apple-arm64-${{ matrix.os }}-${{ matrix.cibw_archs }}-${{ matrix.cibw_build }}
          path: dist/*.whl
          retention-days: 1
